-- CREATING STAGING AREAS FOR EACH YEAR FROM FLIGHT DATA SO AS TO SEE WHAT NEEDS TO BE TRANSFORMED FOR EACH YEAR
DROP TABLE NY2019_STAGEAREA
CREATE TABLE NY2019_STAGEAREA AS SELECT ID,YEAR, DESTINATION_AIRPORT, CANCELLED, DIVERTED FROM NY2019;

DROP TABLE NY2020_STAGEAREA
CREATE TABLE NY2020_STAGEAREA AS SELECT ID, YEAR, DESTINATION_AIRPORT, CANCELLED, DIVERTED  FROM NY2020;

DROP TABLE NY2021_STAGEAREA
CREATE TABLE NY2021_STAGEAREA AS SELECT ID, YEAR, DESTINATION_AIRPORT, CANCELLED, DIVERTED  FROM NY2021;

DROP TABLE NY2022_STAGEAREA
CREATE TABLE NY2022_STAGEAREA AS SELECT ID, YEAR, DESTINATION_AIRPORT, CANCELLED, DIVERTED  FROM NY2022;

DROP TABLE NY2023_STAGEAREA
CREATE TABLE NY2023_STAGEAREA AS SELECT ID, DATE_, DESTINATION_AIRPORT, CANCELLED, DIVERTED FROM NY2023;
SELECT * FROM NY2022_STAGEAREA

--CREATING STAGING AREA FOR COMPLAINT FROM NYAIRPORT_COMPLAINT 
DROP TABLE COMPLAINT_STAGEAREA
CREATE TABLE COMPLAINT_STAGEAREA AS SELECT complaint_id, year, complaint_status FROM NYAIRPORT_COMPLAINT


--USING THE DISTINCT FUNCTION TO CHECK FOR ERRORS IN EACH STAGING AREA 

--FOR FLIGHT STAGEAREA
SELECT DISTINCT YEAR, DESTINATION_AIRPORT, CANCELLED, DIVERTED  FROM NY2019_STAGEAREA;
SELECT DISTINCT YEAR, DESTINATION_AIRPORT, CANCELLED, DIVERTED FROM NY2020_STAGEAREA;
SELECT DISTINCT YEAR, DESTINATION_AIRPORT, CANCELLED, DIVERTED FROM NY2021_STAGEAREA;
SELECT DISTINCT YEAR, DESTINATION_AIRPORT, CANCELLED, DIVERTED FROM NY2022_STAGEAREA;
SELECT DISTINCT DATE_, DESTINATION_AIRPORT, CANCELLED, DIVERTED  FROM NY2023;

SELECT DISTINCT YEAR  FROM NY2019_STAGEAREA;
SELECT DISTINCT DESTINATION_AIRPORT FROM NY2019_STAGEAREA;
SELECT DISTINCT  CANCELLED FROM NY2019_STAGEAREA;
SELECT DISTINCT  DIVERTED FROM NY2019_STAGEAREA;

SELECT DISTINCT YEAR  FROM NY2020_STAGEAREA;
SELECT DISTINCT DESTINATION_AIRPORT FROM NY2020_STAGEAREA;
SELECT DISTINCT  CANCELLED FROM NY2020_STAGEAREA;
SELECT DISTINCT  DIVERTED FROM NY2020_STAGEAREA;


SELECT DISTINCT YEAR  FROM NY2021_STAGEAREA;
SELECT DISTINCT DESTINATION_AIRPORT FROM NY2021_STAGEAREA;
SELECT DISTINCT  CANCELLED FROM NY2021_STAGEAREA;
SELECT DISTINCT  DIVERTED FROM NY2021_STAGEAREA;

SELECT DISTINCT YEAR  FROM NY2022_STAGEAREA;
SELECT DISTINCT DESTINATION_AIRPORT FROM NY2022_STAGEAREA;
SELECT DISTINCT  CANCELLED FROM NY2022_STAGEAREA;
SELECT DISTINCT  DIVERTED FROM NY2022_STAGEAREA;

SELECT DISTINCT DATE_  FROM NY2023_STAGEAREA;
SELECT DISTINCT DESTINATION_AIRPORT FROM NY2023_STAGEAREA;
SELECT DISTINCT  CANCELLED FROM NY2023_STAGEAREA;
SELECT DISTINCT  DIVERTED FROM NY2023_STAGEAREA;

-- FROM THE OUTPUT OF THE DISTINCT FOR FLIGHT, NY2022_STAGEAREA AND NY2023_STAGEAREA NEED CLEANING
--FOR COMPLAINT STAGEAREA
SELECT DISTINCT COMPLAINT_STATUS FROM COMPLAINT_STAGEAREA;
SELECT DISTINCT YEAR FROM COMPLAINT_STAGEAREA;

-- FROM THE OUTPUT OF THE DISTINCT FOR COMPLAINT, COMPLAINT_STATUS NEEDS CLEANING AND COLUMNS THAT HAVE THE YEAR AS 2024 WILL ALSO BE DELETED AS I ONLY
--NEED UP TO 2023 SO AS TO MATCH WITH THE FLIGHTS DATA THAT IS UP TO 2023



--CREATING AN ETL LOG FOR 2022
DROP TABLE ETL_LOG2022
CREATE TABLE etl_log2022
(issue_id NUMBER(5) NOT NULL, 
table_name VARCHAR2(20),
data_error_code NUMBER(5),
issue_desc VARCHAR2(50),
issue_date DATE, 
issue_status VARCHAR2(20),
status_update_date DATE);

DROP SEQUENCE EL_SEQ22
create sequence EL_SEQ22
start with 1
increment by 1
maxvalue 10000
minvalue 1;


CREATE or REPLACE trigger trg_quality_chk2022
  before delete on NY2022_STAGEAREA
begin  
  INSERT INTO etl_log2022
  (issue_id,  table_name,  data_error_code,  issue_desc,  issue_date, issue_status, status_update_date)
   VALUES
  (EL_SEQ.nextval, 'NY2022_STAGEAREA', '0', 'Quality checks', SYSDATE, 'completed', SYSDATE);
end;

--TRANSFORMATION FOR NY2022_STAGEAREA
DELETE FROM NY2022_STAGEAREA
WHERE YEAR IS NULL AND DESTINATION_AIRPORT IS NULL;
SELECT * FROM NY2022_STAGEAREA

--CREATING AN ETL LOG FOR 2023

CREATE TABLE etl_log2023
(issue_id NUMBER(5) NOT NULL, 
table_name VARCHAR2(20),
data_error_code NUMBER(5),
issue_desc VARCHAR2(50),
issue_date DATE, 
issue_status VARCHAR2(20),
status_update_date DATE);


create sequence EL_SEQ23
start with 1
increment by 1
maxvalue 10000
minvalue 1;


CREATE or REPLACE trigger trg_quality_chk2023
  before update on NY2023_STAGEAREA
begin  
  INSERT INTO etl_log2023
  (issue_id,  table_name,  data_error_code,  issue_desc,  issue_date, issue_status, status_update_date)
   VALUES
  (EL_SEQ.nextval, 'NY2023_STAGEAREA', '0', 'Quality checks', SYSDATE, 'completed', SYSDATE);
end;



--TRANSFORMATION FOR NY2023_STAGEAREA
ALTER TABLE NY2023_STAGEAREA
ADD YEAR NUMBER;
UPDATE NY2023_STAGEAREA SET YEAR = 2023 WHERE DATE_ LIKE '%23';
--A new column called YEAR was created and the update statement adds values where date ends with 23 to column year
ALTER TABLE NY2023_STAGEAREA
Drop COLUMN DATE_;
SELECT * FROM NY2023_STAGEAREA


--CREATING AN ETL LOG FOR COMPLAINT
CREATE TABLE etl_logcomplaint
(issue_id NUMBER(5) NOT NULL, 
table_name VARCHAR2(20),
data_error_code NUMBER(5),
issue_desc VARCHAR2(50),
issue_date DATE, 
issue_status VARCHAR2(20),
status_update_date DATE);


create sequence EL_SEQcomplaint
start with 1
increment by 1
maxvalue 10000
minvalue 1;

CREATE or REPLACE trigger trg_quality_chkcomplaint
  before update on COMPLAINT_STAGEAREA
begin  
  INSERT INTO etl_logcomplaint
  (issue_id,  table_name,  data_error_code,  issue_desc,  issue_date, issue_status, status_update_date)
   VALUES
  (EL_SEQ.nextval, 'COMPLAINT_STAGEAREA', '0', 'Quality checks', SYSDATE, 'completed', SYSDATE);
end;

--TRANSFORMATION FOR COMPLAINT_STAGEAREA

UPDATE COMPLAINT_STAGEAREA SET COMPLAINT_STATUS= 'Closed' WHERE COMPLAINT_STATUS = 'closed';
UPDATE COMPLAINT_STAGEAREA SET COMPLAINT_STATUS= 'Open' WHERE COMPLAINT_STATUS = 'open';
DELETE FROM COMPLAINT_STAGEAREA WHERE THE_YEAR LIKE '%24';

--LOAD

--CREATING THE FACT TABLE
drop table fact_flights
CREATE TABLE FACT_FLIGHTS(
	fact_id	INTEGER NOT NULL,
	time_id_fk	INTEGER NOT NULL,
	location_id_fk	INTEGER NOT NULL,
    total_flights INTEGER,
    total_complaints	INTEGER,
    total_closed INTEGER,
    total_diverted INTEGER,
    total_cancelled INTEGER,
	
	CONSTRAINT	FACT_FLIGHTS_pk PRIMARY KEY (fact_id)
);

--CREATING THE TIME DIM TABLE

CREATE TABLE the_time_dim(
	time_id	INTEGER NOT NULL,
	the_year	INTEGER,
	-- Specify the PRIMARY KEY constraint for table "time_dim".
	-- This indicates which attribute(s) uniquely identify each row of data.
	CONSTRAINT	the_time_dim_pk PRIMARY KEY (time_id)
);

--CREATING SURROGATE VALUES FOR TIME DIM PRIMARY KEY USING THE SEQUENCE FUNCTION
create sequence timedim_seq
start with 1
increment by 1
maxvalue 10000
minvalue 1;



--INSERTING VALUES INTO THE TIME DIM
INSERT INTO the_time_dim (time_id, the_year)
SELECT timedim_seq.nextval, YEAR
FROM (SELECT DISTINCT YEAR FROM NY2019_STAGEAREA);

INSERT INTO the_time_dim (time_id, the_year)
SELECT timedim_seq.nextval, YEAR
FROM (SELECT DISTINCT YEAR FROM NY2020_STAGEAREA);

INSERT INTO the_time_dim (time_id, the_year)
SELECT timedim_seq.nextval, YEAR
FROM (SELECT DISTINCT YEAR FROM NY2021_STAGEAREA);

INSERT INTO the_time_dim (time_id, the_year)
SELECT timedim_seq.nextval, YEAR
FROM (SELECT DISTINCT YEAR FROM NY2022_STAGEAREA);

INSERT INTO the_time_dim (time_id, the_year)
SELECT timedim_seq.nextval, YEAR
FROM (SELECT DISTINCT YEAR FROM NY2023_STAGEAREA);

SELECT * FROM the_time_dim ORDER BY THE_YEAR ASC

--CREATING LOCATION DIM TABLE

CREATE TABLE the_location_dim(
	location_id	INTEGER NOT NULL,
	location_name_dest		VARCHAR(10),
	-- Specify the PRIMARY KEY constraint for table "location_dim".
	-- This indicates which attribute(s) uniquely identify each row of data.
	CONSTRAINT	the_location_dim_pk PRIMARY KEY (location_id)
);

--INSERTING VALUES INTO THE LOCATION DIMENSION STARTING OFF WITH CREATING THE SEQUENCE
create sequence locdim_seq
start with 1
increment by 1
maxvalue 10000
minvalue 1;

--CREATING A TEMPORARY TABLE TO HOLD DISTINCT DESTINATION_AIRPORT FROM EACH YEAR'S STAGEAREA
Create table tmp_locationdim as SELECT DISTINCT DESTINATION_AIRPORT FROM NY2020_STAGEAREA;
INSERT INTO tmp_locationdim select distinct destination_airport from NY2019_STAGEAREA;
INSERT INTO tmp_locationdim select distinct destination_airport from NY2021_STAGEAREA;
INSERT INTO tmp_locationdim select distinct destination_airport from NY2022_STAGEAREA;
INSERT INTO tmp_locationdim select distinct destination_airport from NY2023_STAGEAREA;
select * from tmp_locationdim


INSERT INTO the_location_dim (location_id, location_name_dest)
SELECT locdim_seq.nextval, destination_airport
FROM (SELECT DISTINCT destination_airport FROM tmp_locationdim);

select * from the_location_dim


-- I CREATED A TABLE CALLED FLIGHTDATA TO SERVE AS A STAGING AREA FOR THE CLEANED FLIGHT DATA FROM 2019-2023 TO MAKE LOADING VALUES INTO THE MEASURES EASIER
CREATE TABLE FLIGHTDATA AS SELECT ID,YEAR, DESTINATION_AIRPORT,CANCELLED, DIVERTED FROM NY2019_STAGEAREA;

INSERT INTO  FLIGHTDATA (SELECT ID,YEAR, DESTINATION_AIRPORT, CANCELLED, DIVERTED FROM NY2020_STAGEAREA);
INSERT INTO  FLIGHTDATA (SELECT ID,YEAR, DESTINATION_AIRPORT, CANCELLED, DIVERTED FROM NY2021_STAGEAREA);
INSERT INTO  FLIGHTDATA (SELECT ID,YEAR, DESTINATION_AIRPORT, CANCELLED, DIVERTED FROM NY2022_STAGEAREA);
INSERT INTO  FLIGHTDATA (SELECT ID,YEAR, DESTINATION_AIRPORT, CANCELLED, DIVERTED FROM NY2023_STAGEAREA);
SELECT * FROM FLIGHTDATA

--CREATING MEASURE FOR TOTAL FLIGHTS
drop table totalflights
CREATE TABLE totalflights AS
SELECT year, destination_airport,  COUNT(ID) as total_flights FROM FLIGHTDATA
GROUP BY year, destination_airport  ;
SELECT * FROM TOTALFLIGHTS ORDER BY YEAR ASC -- THIS WORKS, IT SHOWS TOTAL FLIGHTS FOR EACH YEAR CORRECTLY, YAY!

--CREATING MEASURE FOR TOTAL DIVERTED
drop table totaldiverted
CREATE TABLE totaldiverted AS
SELECT year, destination_airport,  SUM(CASE WHEN diverted = 1 THEN 1 ELSE 0 END) AS total_diverted
FROM FLIGHTDATA GROUP BY year, destination_airport;
select * from totaldiverted order by year ASC

--CREATING MEASURE FOR TOTAL CANCELLED
drop table totalcancelled
CREATE TABLE totalcancelled AS
SELECT year, destination_airport,  COUNT (CASE WHEN cancelled = 1 THEN 1 ELSE NULL END) AS total_cancelled
FROM FLIGHTDATA GROUP BY year, destination_airport;
select * from totalcancelled order by year ASC



--CREATING MEASURE FOR TOTALCOMPLAINTS
CREATE TABLE totalcomplaints AS
SELECT the_year, COUNT(COMPLAINT_ID) as total_complaints FROM COMPLAINT_STAGEAREA
GROUP BY the_year;

SELECT * FROM totalcomplaints;

--CREATING MEASURE FOR TOTALCLOSED
CREATE TABLE totalclosed AS
SELECT the_year, COUNT(CASE WHEN COMPLAINT_STATUS = 'Closed' THEN 1 ELSE NULL END) AS total_closedcomplaints FROM COMPLAINT_STAGEAREA
GROUP BY the_year;

SELECT * FROM totalclosed;

--INSERTING INTO THE FACT TABLE
create sequence FACTFLIGHTS_SEQ
start with 1
increment by 1
maxvalue 10000
minvalue 1;
--MAYBE FINAL INSERT CODE FOR FACT FLIGHTS
INSERT INTO FACT_FLIGHTS (
    FACT_ID, 
    TIME_ID_FK, 
    LOCATION_ID_FK, 
    TOTAL_FLIGHTS, 
    TOTAL_COMPLAINTS, 
    TOTAL_CLOSED, 
    TOTAL_DIVERTED, 
    TOTAL_CANCELLED
)
SELECT 
   FACTFLIGHTS_SEQ.nextval,  
    THE_TIME_DIM.time_id, 
    THE_LOCATION_DIM.location_id, 
    totalflights.TOTAL_FLIGHTS, 
    (SELECT TOTAL_COMPLAINTS 
     FROM totalcomplaints 
     WHERE totalcomplaints.the_year = the_time_dim.the_year ) AS TOTAL_COMPLAINTS,
    (SELECT TOTAL_CLOSEDcomplaints 
     FROM totalclosed 
     WHERE totalclosed.the_year = the_time_dim.the_year ) AS TOTAL_CLOSED,
    (SELECT TOTAL_DIVERTED 
     FROM totaldiverted 
     WHERE totaldiverted.year = the_time_dim.the_year 
       AND totaldiverted.destination_airport = the_location_dim.location_name_dest) AS TOTAL_DIVERTED,
    (SELECT TOTAL_CANCELLED 
     FROM totalcancelled 
     WHERE totalcancelled.year = the_time_dim.the_year 
       AND totalcancelled.destination_airport = the_location_dim.location_name_dest) AS TOTAL_CANCELLED
FROM  
    the_time_dim, the_location_dim, totalflights
WHERE 
    totalflights.year = the_time_dim.the_year 
    AND totalflights.destination_airport = the_location_dim.location_name_dest;

Select * from fact_flights ORDER BY time_id_fk ASC